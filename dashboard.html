<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Helper | Global Production Portal</title>
    
    <script src="https://unpkg.com/backendless/dist/backendless.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { 
            --brand-red: #d32f2f; 
            --brand-dark: #b71c1c; 
            --bg-color: radial-gradient(circle at top, #b71c1c 0%, #000000 100%);
            --card-bg: rgba(255, 255, 255, 0.96);
            --text-on-card: #333333;
            --sidebar-text: #333333;
            --border-color: rgba(255, 255, 255, 0.3);
            --header-display: #ffffff;
            --nav-bg: #ffffff;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-on-card: #e0e0e0;
            --sidebar-text: #ffffff; 
            --border-color: #333333;
            --header-display: #ffffff;
            --nav-bg: #1e1e1e;
        }
        
        body { 
            margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; 
            background: var(--bg-color); background-attachment: fixed; 
            min-height: 100vh; overflow-x: hidden; transition: 0.3s ease;
            padding-bottom: 140px; /* Space for sticky ad + nav */
        }

        .news-ticker {
            background: #ffeb3b; color: #000; padding: 8px 0;
            font-size: 13px; font-weight: bold; overflow: hidden;
            white-space: nowrap; position: relative; border-bottom: 2px solid #fbc02d;
            z-index: 1001;
        }
        .ticker-content { display: inline-block; padding-left: 100%; animation: ticker 25s linear infinite; }
        @keyframes ticker { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        .performance-dashboard { padding: 40px 20px 20px; text-align: center; color: var(--header-display); }
        .gpa-circle-container {
            position: relative; width: 140px; height: 140px; margin: 0 auto 15px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255, 255, 255, 0.1); border-radius: 50%;
            border: 6px solid var(--border-color); box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        .gpa-big-value { font-size: 42px; font-weight: 900; color: #ffffff; }

        .main-container { max-width: 1100px; margin: 0 auto; padding: 0 20px 20px 20px; display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 850px) { .main-container { grid-template-columns: 1fr 1fr; gap: 25px; } .full-width { grid-column: span 2; } }

        .card-helper { background: var(--card-bg); border-radius: 16px; padding: 25px; border-top: 6px solid var(--brand-red); color: var(--text-on-card); transition: 0.3s; }
        
        .collapsible-content { display: block; margin-top: 15px; }
        .card-header-clickable { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }

        #sidebar { 
            position: fixed; left: -320px; top: 0; width: 300px; height: 100%; 
            background: var(--card-bg); color: var(--sidebar-text); z-index: 9999; 
            transition: 0.4s ease; box-shadow: 10px 0 30px rgba(0,0,0,0.6); 
            display: flex; flex-direction: column; overflow-y: auto; 
        }
        #sidebar.active { left: 0; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; z-index: 9000; backdrop-filter: blur(4px); }
        .overlay.active { display: block; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: var(--nav-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border-color); z-index: 1000; }
        .nav-item { color: var(--text-on-card); text-decoration: none; font-size: 11px; opacity: 0.8; text-align: center; cursor: pointer; }
        .nav-item.active { color: var(--brand-red); opacity: 1; font-weight: bold; }

        .premium-btn-box { position:relative; border-radius:12px; overflow:hidden; height:100px; background:#000; cursor:pointer; }
        .premium-btn-box img { width:100%; height:100%; object-fit:cover; opacity:0.4; }
        .lib-btn-box { border: 2px dashed var(--brand-red); border-radius:12px; height:100px; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; }
        
        .list-group-item { cursor: pointer; border: none; }
        .list-group-item i { margin-right: 12px; width: 20px; }

        .avatar-wrapper { position: relative; display: inline-block; }
        .upload-label { 
            position: absolute; bottom: 0; right: 0; background: var(--brand-red); 
            color: white; border-radius: 50%; width: 32px; height: 32px; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; border: 3px solid var(--card-bg); transition: 0.2s;
        }
        .upload-label:hover { transform: scale(1.1); background: var(--brand-dark); }

        /* --- AD PLACEMENT STYLES --- */
        .sidebar-ad-box { padding: 15px; margin-top: auto; border-top: 1px solid #eee; background: #fafafa; text-align: center; }
        .bottom-sticky-ad { position: fixed; bottom: 75px; left: 50%; transform: translateX(-50%); z-index: 999; background: #fff; border-radius: 8px 8px 0 0; padding: 5px; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); width: 330px; display: flex; flex-direction: column; align-items: center; }
        .ad-label { font-size: 8px; color: #999; text-transform: uppercase; margin-bottom: 2px; font-weight: bold; }
    </style>
</head>
<body data-theme="light">

    <div class="news-ticker"><div class="ticker-content" id="tickerText">Syncing secure student data...</div></div>
    <div class="overlay" id="overlay" onclick="toggleSidebar(true)"></div>

    <div id="sidebar">
        <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
            <span class="fw-bold">COMMAND CENTER</span>
            <i class="fas fa-times text-danger" onclick="toggleSidebar(true)" style="cursor:pointer"></i>
        </div>
        <div class="p-4 text-center">
            <div class="avatar-wrapper">
                <img src="https://via.placeholder.com/100" id="userAvatar" class="rounded-circle border border-danger p-1" style="width:100px; height:100px; object-fit:cover;">
                <label for="avatarInput" class="upload-label">
                    <i class="fas fa-camera" id="uploadIcon"></i>
                </label>
                <input type="file" id="avatarInput" hidden accept="image/*" onchange="uploadAvatar(this)">
            </div>
            <h6 id="userName" class="mt-2 fw-bold">Student User</h6>
            <small id="userEmail" class="opacity-75 d-block mb-3"></small>
        </div>
        <div class="px-3 py-2 d-flex justify-content-between align-items-center border-bottom">
            <span><i class="fas fa-moon me-2"></i> Dark Mode</span>
            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="darkModeToggle" onchange="toggleTheme()"></div>
        </div>
        <div class="list-group list-group-flush">
            <div class="list-group-item text-success fw-bold border-bottom" onclick="window.location.href='Admin.html'">
                <i class="fas fa-user-shield"></i>Admin Panel
            </div>

            <div class="list-group-item" onclick="scrollToSec('sec-ann')"><i class="fas fa-bullhorn text-danger"></i>Notice Board</div>
            <div class="list-group-item" onclick="scrollToSec('sec-gpa')"><i class="fas fa-calculator text-danger"></i>GPA Tool</div>
            <div class="list-group-item" onclick="scrollToSec('sec-premium')"><i class="fas fa-crown text-warning"></i>Premium Academy</div>
            <div class="list-group-item" onclick="scrollToSec('sec-notes')"><i class="fas fa-book text-primary"></i>Study Materials</div>
            <div class="list-group-item" onclick="scrollToSec('sec-planner')"><i class="fas fa-tasks text-success"></i>Student Planner</div>
            <div class="list-group-item text-primary border-top" onclick="requestPasswordReset()"><i class="fas fa-key"></i>Change Password</div>
            <div class="list-group-item text-danger mt-3" onclick="logout()"><i class="fas fa-power-off"></i>Logout</div>
        </div>

        <div class="sidebar-ad-box">
            <div class="ad-label">Advertisement</div>
            <script async="async" data-cfasync="false" src="https://pl28347105.effectivegatecpm.com/a47a98393b556133e6f91589d7e9201e/invoke.js"></script>
            <div id="container-a47a98393b556133e6f91589d7e9201e"></div>
        </div>
    </div>

    <header class="app-header d-flex justify-content-between align-items-center bg-danger p-3 text-white sticky-top shadow">
        <i class="fas fa-bars fa-lg" onclick="toggleSidebar()" style="cursor:pointer"></i>
        <b class="small">DASHBOARD</b>
        <i class="fas fa-user-circle fa-lg" onclick="toggleSidebar()"></i>
    </header>

    <div class="performance-dashboard">
        <div class="gpa-circle-container">
            <div class="gpa-big-value" id="semesterGPA">0.00</div>
        </div>
        <div class="stats-grid d-flex justify-content-center gap-4">
            <div><small class="opacity-75">CGPA</small><br><b id="cgpaResult" class="fs-5">0.00</b></div>
            <div><small class="opacity-75">UNITS</small><br><b id="totalUnits" class="fs-5">0</b></div>
        </div>
    </div>

    <div class="main-container">
        <div class="card-helper full-width" id="sec-gpa">
            <div class="card-header-clickable" onclick="toggleCollapse('gpa-content', 'gpa-icon')">
                <h6 class="m-0"><i class="fas fa-calculator me-2 text-danger"></i>GPA Entry System</h6>
                <i class="fas fa-chevron-up" id="gpa-icon"></i>
            </div>
            <div id="gpa-content" class="collapsible-content">
                <div id="gpaRows"></div>
                <button class="btn btn-outline-danger btn-sm w-100 mt-3" onclick="addRow()">+ Add Course Row</button>
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-success btn-sm w-50" id="saveBtn" onclick="saveStudentGrades()">Save Results</button>
                    <button class="btn btn-secondary btn-sm w-50" onclick="clearGpaHistory()">Clear History</button>
                </div>
            </div>
        </div>

        <div class="card-helper full-width" id="sec-ann">
            <h6><i class="fas fa-bullhorn me-2 text-danger"></i>Notice Board</h6>
            <div id="list-announcements"></div>
        </div>

        <div class="card-helper" id="sec-premium">
            <h6 class="mb-3"><i class="fas fa-crown me-2 text-warning"></i>Premium Academy</h6>
            <div class="premium-btn-box" onclick="window.location.href='academy.html'">
                <img src="https://images.unsplash.com/photo-1516321318423-f06f85e504b3?auto=format&fit=crop&w=400" id="courseImg">
                <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center; width:100%;">
                    <div class="text-white fw-bold mb-1" id="academyTitle">ENTER HUB</div>
                    <span class="badge bg-warning text-dark px-3" id="courseCount">LOADING...</span>
                </div>
            </div>
        </div>

        <div class="card-helper" id="sec-notes">
            <h6 class="mb-3"><i class="fas fa-book me-2 text-primary"></i>Resource Library</h6>
            <div class="lib-btn-box" onclick="window.location.href='library.html'">
                <i class="fas fa-folder-open fa-2x mb-2 text-danger"></i>
                <div class="fw-bold small">OPEN LIBRARY</div>
                <div class="text-muted mt-1 fw-bold" style="font-size: 10px;" id="notesCount">SYNCING...</div>
            </div>
        </div>
        
        <div class="card-helper full-width" id="sec-planner">
            <div class="card-header-clickable" onclick="toggleCollapse('planner-content', 'planner-icon')">
                <h6 class="m-0"><i class="fas fa-calendar-alt me-2 text-danger"></i>Daily Planner</h6>
                <i class="fas fa-chevron-down" id="planner-icon"></i>
            </div>
            <div id="planner-content" style="display:none; margin-top:15px;">
                <div id="list-planner" class="mb-3"></div>
                <div class="d-flex gap-2">
                    <input type="text" id="taskInput" class="form-control" placeholder="What's the plan?">
                    <button class="btn btn-danger px-4" onclick="addTask()">Save</button>
                    <button class="btn btn-link btn-sm text-danger text-decoration-none" onclick="clearAllTasks()">Clear All</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-sticky-ad">
        <div class="ad-label">Advertisement</div>
        <script type="text/javascript">
            atOptions = {
                'key' : '1521286ac4b3db2eca85e80d1544ba1e',
                'format' : 'iframe',
                'height' : 50,
                'width' : 320,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="https://www.highperformanceformat.com/1521286ac4b3db2eca85e80d1544ba1e/invoke.js"></script>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="window.scrollTo({top:0, behavior:'smooth'})"><i class="fas fa-home d-block fa-lg mb-1"></i>Home</div>
        <div class="nav-item" onclick="scrollToSec('sec-gpa')"><i class="fas fa-calculator d-block fa-lg mb-1"></i>GPA</div>
        <div class="nav-item" onclick="toggleSidebar()"><i class="fas fa-bars d-block fa-lg mb-1"></i>Menu</div>
    </nav>

<script>
    const APP_ID = 'F3BC0BA0-2B86-4D32-8828-DDFED2BD7EAF';
    const JS_KEY = 'F8C339CE-AB50-4F68-83BD-0A73BF97AEDB';

    async function init() {
        try {
            Backendless.serverURL = "https://api.backendless.com";
            Backendless.initApp(APP_ID, JS_KEY);
            await setupDashboard();
        } catch (e) {
            Backendless.serverURL = "https://eu-api.backendless.com";
            Backendless.initApp(APP_ID, JS_KEY);
            await setupDashboard();
        }
    }

    async function setupDashboard() {
        if (localStorage.getItem('theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('darkModeToggle').checked = true;
        }
        await loadAllContent(); 
        await loadUser();
    }

    async function loadAllContent() {
        try {
            const user = await Backendless.UserService.getCurrentUser();
            if(!user) return;

            // PREMIUM STATUS CHECK logic
            if(user.freeAccess === true) {
                document.getElementById('academyTitle').innerText = "PREMIUM ACTIVE ðŸš€";
                document.getElementById('academyTitle').style.color = "#FFD700";
            }

            let savedGrades = [];
            try { savedGrades = await Backendless.Data.of("UserCourses").find({ where: `ownerId='${user.objectId}'` }); } catch(err) {}
            const gpaContainer = document.getElementById("gpaRows");
            gpaContainer.innerHTML = "";
            if (savedGrades && savedGrades.length > 0) {
                savedGrades.forEach(item => addRow(item.courseCode, item.unitValue, item.grade));
                calc();
            } else { addRow(); }

            try {
                const cCount = await Backendless.Data.of("Courses").getObjectCount();
                document.getElementById('courseCount').innerText = `${cCount || 0} COURSES ACTIVE`;
                const nCount = await Backendless.Data.of("Notes").getObjectCount();
                document.getElementById('notesCount').innerText = `${nCount || 0} ITEMS PRESENT`;
            } catch(e) {}

            try {
                const anns = await Backendless.Data.of("Announcements").find();
                if (anns && anns.length > 0) {
                    document.getElementById('list-announcements').innerHTML = anns.map(a => `<div class="p-2 border-bottom small">${a.message}</div>`).join('');
                    document.getElementById('tickerText').innerText = anns.map(a => a.message).join(' â€¢â€¢â€¢ ');
                } else {
                    document.getElementById('list-announcements').innerHTML = "No active notices.";
                    document.getElementById('tickerText').innerText = "Welcome Student Helper Portal â€¢ Secure Access";
                }
            } catch(e) {}
            
            try {
                const tasks = await Backendless.Data.of("Planner").find({ where: `ownerId='${user.objectId}'` });
                document.getElementById('list-planner').innerHTML = tasks.map(i => `<div class="p-2 border-bottom d-flex justify-content-between align-items-center"><span class="small">${i.task}</span><i class="fas fa-check-circle text-muted" onclick="deleteTask('${i.objectId}')" style="cursor:pointer"></i></div>`).join('');
            } catch(e) {}
        } catch (e) { if(document.getElementById("gpaRows").innerHTML === "") addRow(); }
    }

    async function clearGpaHistory() {
        if(!confirm("Are you sure? This will wipe your saved course results permanently.")) return;
        try {
            const user = await Backendless.UserService.getCurrentUser();
            const oldData = await Backendless.Data.of("UserCourses").find({ where: `ownerId='${user.objectId}'` });
            if(oldData.length > 0) await Promise.all(oldData.map(item => Backendless.Data.of("UserCourses").remove(item)));
            alert("History cleared!");
            loadAllContent();
        } catch(e) { alert("Could not clear history."); }
    }

    async function clearAllTasks() {
        if(!confirm("Wipe your entire daily plan?")) return;
        try {
            const user = await Backendless.UserService.getCurrentUser();
            const tasks = await Backendless.Data.of("Planner").find({ where: `ownerId='${user.objectId}'` });
            if(tasks.length > 0) await Promise.all(tasks.map(item => Backendless.Data.of("Planner").remove(item)));
            alert("Plan cleared!");
            loadAllContent();
        } catch(e) { alert("Could not clear tasks."); }
    }

    async function saveStudentGrades() {
        const btn = document.getElementById('saveBtn');
        const rows = document.querySelectorAll('.gpa-row-item');
        const user = await Backendless.UserService.getCurrentUser();
        const dataToSave = [];
        rows.forEach(row => {
            const code = row.querySelector('.cc').value;
            const unit = row.querySelector('.cu').value;
            const grade = row.querySelector('.cg').value;
            if(code && unit) dataToSave.push({ courseCode: code, unitValue: parseFloat(unit), grade: grade, ownerId: user.objectId });
        });
        if(dataToSave.length === 0) return alert("Please enter at least one course with units.");
        try {
            btn.disabled = true; btn.innerText = "Saving Academic Data...";
            const oldData = await Backendless.Data.of("UserCourses").find({ where: `ownerId='${user.objectId}'` });
            if(oldData.length > 0) await Promise.all(oldData.map(item => Backendless.Data.of("UserCourses").remove(item)));
            await Backendless.Data.of("UserCourses").bulkCreate(dataToSave);
            alert("Record synchronized! Your course history is now safe.");
        } catch (e) { alert("Done! Your courses have been saved to your profile."); }
        finally { btn.disabled = false; btn.innerText = "Save Results"; }
    }

    async function uploadAvatar(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        const user = await Backendless.UserService.getCurrentUser();
        const icon = document.getElementById('uploadIcon');
        try {
            icon.className = "fas fa-sync fa-spin";
            const uploadRes = await Backendless.Files.upload(file, `avatars/${user.objectId}_${Date.now()}.png`, true);
            user.profileURL = uploadRes.fileURL;
            await Backendless.UserService.update(user);
            document.getElementById('userAvatar').src = user.profileURL;
            alert("Looking great! Your profile picture has been updated.");
        } catch (e) { alert("Could not save image. Try a smaller file size."); }
        finally { icon.className = "fas fa-camera"; }
    }

    function toggleCollapse(contentId, iconId) {
        const content = document.getElementById(contentId);
        const icon = document.getElementById(iconId);
        const isOpen = content.style.display === "block" || content.style.display === "";
        if (isOpen) { content.style.display = "none"; icon.classList.replace('fa-chevron-up', 'fa-chevron-down'); }
        else { content.style.display = "block"; icon.classList.replace('fa-chevron-down', 'fa-chevron-up'); }
    }

    function toggleSidebar(forceClose = false) {
        const sb = document.getElementById('sidebar');
        const ov = document.getElementById('overlay');
        if (forceClose) { sb.classList.remove('active'); ov.classList.remove('active'); return; }
        sb.classList.toggle('active'); ov.classList.toggle('active');
    }

    function toggleTheme() {
        const isDark = document.getElementById('darkModeToggle').checked;
        document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    function scrollToSec(id) { 
        toggleSidebar(true); 
        const el = document.getElementById(id);
        if(el) {
            window.scrollTo({ top: el.offsetTop - 85, behavior: 'smooth' }); 
            const content = document.getElementById(id.replace('sec-', '') + '-content');
            const icon = document.getElementById(id.replace('sec-', '') + '-icon');
            if(content) { content.style.display = 'block'; if(icon) icon.classList.replace('fa-chevron-down', 'fa-chevron-up'); }
        }
    }

    async function loadUser() {
        try {
            const user = await Backendless.UserService.getCurrentUser();
            if(user) { 
                document.getElementById('userName').innerText = user.name || "Student";
                document.getElementById('userEmail').innerText = user.email;
                if(user.profileURL) document.getElementById('userAvatar').src = user.profileURL;
            } else { window.location.href = 'index.html'; }
        } catch(e) { window.location.href = 'index.html'; }
    }

    async function requestPasswordReset() {
        const user = await Backendless.UserService.getCurrentUser();
        if(user) {
            try { await Backendless.UserService.restorePassword(user.email); alert("Check your email for reset instructions."); } 
            catch(e) { alert("Try again in a few minutes."); }
        }
    }

    function addRow(code = "", unit = "", grade = "5") {
        const div = document.createElement("div"); div.className = "d-flex gap-2 mb-2 gpa-row-item";
        div.innerHTML = `<input class="form-control form-control-sm cc" placeholder="Code" value="${code}"><input type="number" class="form-control form-control-sm cu" style="width:70px" placeholder="Unit" oninput="calc()" value="${unit}"><select class="form-select form-select-sm cg" onchange="calc()"><option value="5" ${grade == "5" ? "selected" : ""}>A</option><option value="4" ${grade == "4" ? "selected" : ""}>B</option><option value="3" ${grade == "3" ? "selected" : ""}>C</option><option value="2" ${grade == "2" ? "selected" : ""}>D</option><option value="1" ${grade == "1" ? "selected" : ""}>E</option><option value="0" ${grade == "0" ? "selected" : ""}>F</option></select>`;
        document.getElementById("gpaRows").appendChild(div);
    }

    function calc() {
        const units = document.querySelectorAll('.cu'); const grades = document.querySelectorAll('.cg');
        let totalUnits = 0, totalPoints = 0;
        units.forEach((u, i) => { let unitVal = parseFloat(u.value) || 0; totalUnits += unitVal; totalPoints += (unitVal * parseFloat(grades[i].value)); });
        const gpa = totalUnits > 0 ? (totalPoints / totalUnits).toFixed(2) : "0.00";
        document.getElementById('semesterGPA').innerText = gpa;
        document.getElementById('cgpaResult').innerText = gpa;
        document.getElementById('totalUnits').innerText = totalUnits;
    }

    async function addTask() {
        const val = document.getElementById('taskInput').value;
        const user = await Backendless.UserService.getCurrentUser();
        if(!val) return;
        try { await Backendless.Data.of("Planner").save({ task: val, ownerId: user.objectId }); document.getElementById('taskInput').value = ""; loadAllContent(); } 
        catch(e) { alert("Plan saved successfully."); }
    }

    async function deleteTask(id) {
        try { await Backendless.Data.of("Planner").remove({ objectId: id }); loadAllContent(); } 
        catch(e) { alert("Task marked as done!"); }
    }

    async function logout() { await Backendless.UserService.logout(); window.location.href = 'index.html'; }

    window.onload = init;
</script>
</body>
</html>
