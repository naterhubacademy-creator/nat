<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NATER HUB | Premium Academy</title>
    <script src="https://unpkg.com/backendless/dist/backendless.min.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Montserrat:wght@400;600;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root { --red: #d32f2f; --gold: #FFD700; --bg: #0a0a0a; }
        body { font-family: 'Montserrat', sans-serif; background: var(--bg); color: white; min-height: 100vh; user-select: none; }
        
        .brand-logo { margin-bottom: 20px; padding-top: 10px; text-align: center; }
        .brand-nater { font-family: 'Cinzel', serif; font-weight: 900; color: var(--gold); letter-spacing: 3px; font-size: 2.2rem; }
        .brand-hub { font-family: 'Cinzel', serif; font-weight: 900; color: var(--red); letter-spacing: 3px; font-size: 2.2rem; }

        .stats-container { display: flex; justify-content: center; gap: 30px; margin-bottom: 20px; width: 100%; }
        .stat-item { text-align: center; background: rgba(255,255,255,0.05); padding: 10px 25px; border-radius: 12px; border-bottom: 2px solid var(--gold); min-width: 150px; }
        .stat-val { color: var(--gold); font-weight: 900; font-size: 1.3rem; display: block; }
        .stat-lbl { font-size: 0.65rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        .search-wrapper { max-width: 500px; margin: 0 auto 15px; position: relative; padding: 0 15px; }
        .search-input { 
            background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 50px; 
            padding: 12px 25px 12px 50px; color: white; width: 100%; transition: 0.3s;
        }
        .search-input:focus { outline: none; border-color: var(--gold); background: rgba(255,255,255,0.1); }
        .search-icon { position: absolute; left: 35px; top: 15px; color: var(--gold); }

        .category-scroll { 
            display: flex; 
            justify-content: flex-start;
            gap: 12px; 
            overflow-x: auto; 
            padding: 10px 20px;
            margin-bottom: 25px; 
            scrollbar-width: none; 
            -webkit-overflow-scrolling: touch;
        }
        @media (min-width: 768px) { .category-scroll { justify-content: center; } }
        
        .category-scroll::-webkit-scrollbar { display: none; }
        .cat-btn { 
            background: #1a1a1a; border: 1px solid #333; color: #888; padding: 10px 24px; 
            border-radius: 50px; font-size: 0.85rem; font-weight: 600; white-space: nowrap; transition: 0.3s;
        }
        .cat-btn.active { background: var(--gold); color: black; border-color: var(--gold); box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3); }

        .nav-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; flex-wrap: wrap; }

        .lesson-header-branding { text-align: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #333; }
        .course-title-style { font-family: 'Cinzel', serif; font-weight: 900; font-size: 1.8rem; letter-spacing: 2px; }

        .lesson-item { background: #151515; border-radius: 15px; padding: 20px; margin-bottom: 15px; border-left: 6px solid var(--red); display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        
        .lesson-locked { opacity: 1 !important; filter: none !important; pointer-events: none; }
        .icon-locked-red { color: #ff3131 !important; font-weight: 900; text-shadow: 0px 0px 10px rgba(255, 49, 49, 0.4); }

        .btn-pdf { background: transparent; color: var(--gold) !important; border: 1px solid var(--gold); padding: 5px 12px; border-radius: 5px; font-weight: bold; font-size: 0.75rem; text-decoration: none; }
        .desktop-notice { font-size: 0.65rem; color: #ff8a8a; display: block; margin-top: 3px; font-weight: 600; text-align: center; text-transform: uppercase; }

        .card-container { position: relative; }
        .badge-new { 
            position: absolute; top: 10px; left: 10px; background: var(--red); 
            color: white; font-size: 0.6rem; padding: 3px 10px; border-radius: 50px; 
            font-weight: 900; z-index: 5; border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        #videoOverlay { display: none; position: fixed; inset: 0; background: black; z-index: 10000; flex-direction: column; align-items: center; justify-content: center; }
        .close-video { position: absolute; top: 20px; right: 20px; background: var(--red); color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; z-index: 10001; }
        
        video { width: 95%; max-width: 1000px; border-radius: 15px; border: 2px solid #333; outline: none; }

        .course-card { background: white; color: #333; border-radius: 20px; overflow: hidden; border-bottom: 6px solid var(--gold); transition: 0.3s; height: 100%; cursor: pointer; }
        .course-card:hover { transform: translateY(-5px); }

        #paymentLoader { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 30000; flex-direction: column; align-items: center; justify-content: center; text-align: center; backdrop-filter: blur(10px); }
        .spinner { width: 60px; height: 60px; border: 6px solid #222; border-top: 6px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #bridgeView { display: none; text-align: center; padding: 40px 20px; }
        .id-box { background: #111; border: 3px solid var(--gold); padding: 30px; border-radius: 20px; margin: 30px auto; max-width: 500px; box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); }
        .instruction-card { background: white; border-radius: 15px; border-left: 12px solid var(--red); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="paymentLoader">
    <div class="spinner"></div>
    <h4 class="fw-bold text-white">VALIDATING TRANSACTION...</h4>
    <p class="text-warning small px-4">Unlocking access. Please do not close this window.</p>
</div>

<div class="container p-3">
    <div id="galleryView">
        <div class="brand-logo">
            <span class="brand-nater">NATER</span><span class="brand-hub">HUB</span>
            <div style="letter-spacing: 5px; color: #666; font-weight: bold; font-size: 0.7rem;">PREMIUM ACADEMY</div>
        </div>

        <div class="stats-container">
            <div class="stat-item"><span class="stat-val" id="courseCount">0</span><span class="stat-lbl">Courses Available</span></div>
            <div class="stat-item"><span class="stat-val" id="studentCount">...</span><span class="stat-lbl">Registered Students</span></div>
        </div>

        <div class="search-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="courseSearch" class="search-input" placeholder="Search for courses..." onkeyup="filterCourses()">
        </div>

        <div class="category-scroll" id="categoryTabs">
            <button class="cat-btn active" onclick="setCategory('All', this)">All</button>
            <button class="cat-btn" onclick="setCategory('Programming', this)">Programming</button>
            <button class="cat-btn" onclick="setCategory('Trading', this)">Trading</button>
            <button class="cat-btn" onclick="setCategory('Design', this)">Design</button>
            <button class="cat-btn" onclick="setCategory('Marketing', this)">Marketing</button>
        </div>

        <div class="nav-container">
            <button class="btn btn-warning rounded-pill px-4 fw-bold shadow" onclick="loadGallery('all')">EXPLORE ALL</button>
            <button class="btn btn-outline-warning rounded-pill px-4 fw-bold shadow" onclick="loadGallery('owned')">MY DASHBOARD</button>
            <a href="verify.html" class="btn btn-outline-light rounded-pill px-4 fw-bold shadow">
                <i class="fas fa-certificate text-warning me-2"></i>VERIFY CERTIFICATE
            </a>
        </div>

        <div id="courseGrid" class="row g-4 text-start"></div>
    </div>

    <div id="lessonView" style="display:none;">
        <div class="mb-4 text-warning fw-bold" style="cursor:pointer;" onclick="goBack()"><i class="fas fa-arrow-left me-2"></i> BACK TO HUB</div>
        <div class="lesson-header-branding">
            <span class="brand-nater course-title-style" id="activeTitleNater"></span><span class="brand-hub course-title-style" id="activeTitleHub"></span>
        </div>
        <div id="certBanner" class="alert alert-dark border-warning p-4 mb-4 text-center" style="display:none; background: #111; border-radius: 15px;">
            <h4 class="text-warning fw-bold">ðŸŽ“ LESSONS COMPLETED!</h4>
            <button class="btn btn-warning fw-bold px-5 py-2" onclick="openBridge()">GENERATE MY CERTIFICATE ID</button>
        </div>
        <div id="lessonList"></div>
    </div>

    <div id="bridgeView">
        <h2 class="brand-nater" style="font-size: 3rem;">ID <span class="brand-hub">SECURED</span></h2>
        <div class="id-box">
            <h1 class="text-white fw-bold mb-4" id="displayId" style="letter-spacing: 5px; font-size: 3rem;">-------</h1>
            <button class="btn btn-warning btn-lg fw-bold w-100 py-3 shadow" onclick="copyId()">CLICK TO COPY ID</button>
        </div>
        <div class="mx-auto" style="max-width: 600px;">
            <div class="instruction-card p-4">
                <h4 class="text-danger fw-bold mb-3"><i class="fas fa-exclamation-triangle"></i> CRITICAL WARNING</h4>
                <div class="text-dark text-start" style="font-weight: 600;">
                    <p>1. Copy the <b>GOLD ID</b> above.</p>
                    <p style="color: #d32f2f;">2. <b>Notice:</b> Use a <b>Desktop Computer/or desktop mode on phone</b> to print the certificate.</p>
                </div>
            </div>
        </div>
        <button class="btn btn-danger btn-lg fw-bold px-5 mt-5" onclick="finalPrint()">STEP 2: PROCEED TO PRINTING PAGE</button>
    </div>
</div>

<div id="videoOverlay">
    <button class="close-video" onclick="closeVideo()">EXIT PLAYER</button>
    <video id="mp4Player" controls controlsList="nodownload"></video>
</div>

<script>
    const APP_ID = 'F3BC0BA0-2B86-4D32-8828-DDFED2BD7EAF';
    const JS_KEY = 'F8C339CE-AB50-4F68-83BD-0A73BF97AEDB';
    const PAYSTACK_KEY = 'pk_live_e4550ea9879afc005733e9f2be957500e1999d8c';
    
    let currentUser = null, currentCourseId = null, currentActiveLessonId = null;
    let allLoadedCourses = [], currentCategory = 'All';

    async function initApp() {
        Backendless.initApp(APP_ID, JS_KEY);
        try {
            currentUser = await Backendless.UserService.getCurrentUser();
            if (!currentUser) return window.location.href = "index.html";
            fetchGlobalStats();
            loadGallery('all');
            document.getElementById('mp4Player').addEventListener('ended', async () => {
                if(currentActiveLessonId) await markDone(currentActiveLessonId);
            });
        } catch (e) { console.error(e); }
    }

    async function fetchGlobalStats() {
        try {
            const count = await Backendless.Data.of("UserSubscriptions").getObjectCount();
            document.getElementById('studentCount').innerText = count; 
        } catch (e) { document.getElementById('studentCount').innerText = "0"; }
    }

    async function loadGallery(filter) {
        const courses = await Backendless.Data.of("Courses").find();
        allLoadedCourses = courses;
        let subs = [];
        try { subs = await Backendless.Data.of("UserSubscriptions").find(Backendless.DataQueryBuilder.create().setWhereClause(`ownerId='${currentUser.objectId}'`)); } catch(e){}
        const ownedIds = subs.map(s => s.courseId);
        allLoadedCourses.forEach(c => { c.isOwned = ownedIds.includes(c.objectId) || currentUser.freeAccess; });
        applyFilters();
    }

    function setCategory(cat, btn) {
        currentCategory = cat;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        applyFilters();
    }

    function filterCourses() { applyFilters(); }

    function applyFilters() {
        const searchQuery = document.getElementById('courseSearch').value.toLowerCase();
        const filtered = allLoadedCourses.filter(c => {
            const matchesSearch = c.title.toLowerCase().includes(searchQuery);
            const matchesCat = currentCategory === 'All' || c.category === currentCategory;
            return matchesSearch && matchesCat;
        });
        renderCourseGrid(filtered);
    }

    function renderCourseGrid(courses) {
        document.getElementById('courseCount').innerText = courses.length;

        document.getElementById('courseGrid').innerHTML = courses.map(c => {
            const createdDate = new Date(c.created || Date.now());
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const isNew = createdDate > sevenDaysAgo;

            return `<div class="col-lg-4 col-md-6 mb-3 card-container">
                ${isNew ? '<span class="badge-new">NEW</span>' : ''}
                <div class="course-card" onclick="checkAccess('${c.objectId}', '${c.title}', ${c.price}, ${c.isOwned})">
                    <img src="${c.thumbnail}" style="height:180px; width:100%; object-fit:cover;">
                    <div class="p-3">
                        <h6 class="fw-bold mb-3" style="color:#333;">${c.title}</h6>
                        <button class="btn btn-dark w-100 btn-sm fw-bold">${c.isOwned ? 'RESUME LEARNING' : 'ENROLL â‚¦' + c.price}</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function checkAccess(id, title, price, owned) {
        if (owned) return openCourse(id, title);
        const handler = PaystackPop.setup({
            key: PAYSTACK_KEY,
            email: currentUser.email,
            amount: price * 100,
            callback: function(response) {
                document.getElementById('paymentLoader').style.display = 'flex';
                
                // Branded Student HTML Receipt
                const studentBody = `<div style="font-family: Arial; border: 1px solid #FFD700; border-radius: 15px; overflow: hidden; max-width: 600px; margin: auto;">
                    <div style="background: #000; padding: 40px; text-align: center;"><h1 style="color: #FFD700; margin: 0; letter-spacing: 5px;">NATER HUB</h1></div>
                    <div style="padding: 30px; color: #333; background: #fff;">
                        <h2>Enrollment Confirmed!</h2>
                        <p>Hello <b>${currentUser.name || 'Scholar'}</b>, you are officially enrolled in <b>${title}</b>.</p>
                        <p style="background: #f4f4f4; padding: 15px; border-radius: 8px;"><b>Ref ID:</b> ${response.reference}</p>
                        <p><b>Note:</b> You must finish watching each video to unlock the next one. Upon completion, use your generated ID on the printing page to get your certificate.</p>
                        <a href="https://naterhubacademy-web.github.io/Nater-Hub-Academy-/" style="background: #d32f2f; color: #fff; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;">GO TO MY DASHBOARD</a>
                    </div>
                </div>`;

                Backendless.Data.of("UserSubscriptions").save({ 
                    courseId: id, 
                    ownerId: currentUser.objectId, 
                    courseName: title, 
                    transactionRef: response.reference 
                })
                .then(() => {
                    document.getElementById('paymentLoader').style.display = 'none';
                    openCourse(id, title);
                    fetchGlobalStats();
                    
                    // SEND EMAILS
                    Backendless.Messaging.sendEmail("Receipt: Successful Enrollment at NATER HUB", { htmlmessage: studentBody }, [currentUser.email]);
                    Backendless.Messaging.sendEmail("ðŸ’° SALE NOTIFICATION", { htmlmessage: `New sale: ${currentUser.email} bought ${title}` }, ["nmbashau@gmail.com"]);
                    
                }).catch((e) => {
                    console.error("Save error:", e);
                    document.getElementById('paymentLoader').style.display = 'none';
                    openCourse(id, title);
                });
            }
        });
        handler.openIframe();
    }

    function openCourse(id, title) {
        currentCourseId = id;
        document.getElementById('galleryView').style.display = 'none';
        document.getElementById('lessonView').style.display = 'block';
        const words = title.split(' ');
        const mid = Math.ceil(words.length / 2);
        document.getElementById('activeTitleNater').innerText = words.slice(0, mid).join(' ') + ' ';
        document.getElementById('activeTitleHub').innerText = words.slice(mid).join(' ');
        renderLessons();
    }

    async function renderLessons() {
        const content = await Backendless.Data.of("CourseContent").find(Backendless.DataQueryBuilder.create().setWhereClause(`courseId='${currentCourseId}'`).setSortBy(["created ASC"]));
        const progress = await Backendless.Data.of("UserProgress").find(Backendless.DataQueryBuilder.create().setWhereClause(`courseId='${currentCourseId}' AND ownerId='${currentUser.objectId}'`));
        const doneIds = new Set(progress.map(p => p.lessonId));
        
        document.getElementById('lessonList').innerHTML = content.map((l, i) => {
            const unlocked = i === 0 || doneIds.has(content[i-1].objectId);
            const icon = unlocked ? (doneIds.has(l.objectId) ? 'fa-check-circle text-success' : 'fa-play-circle text-warning') : 'fa-lock icon-locked-red';
            let pdf = l.pdfUrl ? `<div class="text-center"><a href="${l.pdfUrl}" target="_blank" class="btn-pdf">PDF</a><span class="desktop-notice">Desktop Only</span></div>` : '';

            return `<div class="lesson-item ${unlocked ? '' : 'lesson-locked'}">
                <div class="fw-bold" style="max-width:55%;">${i+1}. ${l.title}</div>
                <div class="d-flex align-items-center">
                    ${pdf}
                    <button class="btn btn-danger btn-sm mx-2 fw-bold" onclick="playVideo('${l.videoUrl}', '${l.objectId}')" ${unlocked?'':'disabled'}>WATCH</button>
                    <i class="fas ${icon} fs-4"></i>
                </div>
            </div>`;
        }).join('');
        if (progress.length >= content.length && content.length > 0) document.getElementById('certBanner').style.display = 'block';
    }

    function playVideo(url, lessonId) { 
        currentActiveLessonId = lessonId;
        const player = document.getElementById('mp4Player');
        player.src = url; document.getElementById('videoOverlay').style.display = 'flex'; player.play();
    }

    async function markDone(lId) {
        await Backendless.Data.of("UserProgress").save({ lessonId: lId, courseId: currentCourseId, ownerId: currentUser.objectId });
        renderLessons();
    }

    async function openBridge() {
        const certId = "NH-ID-" + Math.floor(100000 + Math.random() * 900000);
        document.getElementById('displayId').innerText = certId;
        await Backendless.Data.of("VerifiedCertificates").save({
            certId: certId, studentName: (currentUser.name || currentUser.email).toUpperCase(),
            courseName: (document.getElementById('activeTitleNater').innerText + document.getElementById('activeTitleHub').innerText).trim()
        });
        document.getElementById('lessonView').style.display = 'none';
        document.getElementById('bridgeView').style.display = 'block';
        window.scrollTo(0,0);
    }

    function copyId() { navigator.clipboard.writeText(document.getElementById('displayId').innerText).then(() => alert("âœ… ID COPIED!")); }
    function finalPrint() { window.open('certificate.html', '_blank'); }
    function closeVideo() { document.getElementById('mp4Player').pause(); document.getElementById('videoOverlay').style.display = 'none'; }
    function goBack() { document.getElementById('galleryView').style.display = 'block'; document.getElementById('lessonView').style.display = 'none'; document.getElementById('bridgeView').style.display = 'none'; }
    window.onload = initApp;
</script>
</body>
</html>
